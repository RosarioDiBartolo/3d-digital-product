import{C as q,b as A,u as se,S as ie,a as ne}from"./chunk-X4NONLSC-CeKp_Bk_.js";import{S as re,C as V}from"./chunk-PYIO3TDQ-D8Zv8hXV.js";import{f as oe}from"./chunk-IR5DHEKS-aVJcUHa1.js";import{u as H}from"./chunk-6CNRNROJ-D8zkyy0p.js";import{C as G}from"./chunk-3LLQ6F7F-yPUjTsfH.js";import{D as te}from"./chunk-GE4APTT2-Di5L0fn6.js";import{a8 as a,S as ae,a1 as ce,b1 as le,au as W,j as e,r as O,b as Q,aa as pe,ab as de,v as U,ey as ue,t as Z,B as K,s as J,H as me,T as he,w as r,x as ge,a7 as N,D as fe,g as xe,i as _e,l as je}from"./index-Caf50g4I.js";import{b as be}from"./chunk-BF3VCHXD-9IuJVecz.js";import{S as ye}from"./chunk-CBJWO6K6-cIyX9zc1.js";import{c as M}from"./chunk-6GU6IDUA-CDc7wW5L.js";import{K as Ce}from"./chunk-6HTZNHPT-_WRLDY31.js";import{R as w,u as X,a as Se,S as ve}from"./chunk-JGQGO74V-CT1-L7kV.js";import{P}from"./progress-tabs-DbsFKogn.js";import{R as B}from"./radio-group-BFyDFX15.js";import"./chunk-PDWBYQOW-BedvhUOI.js";import"./chunk-MWVM4TYO-bKUcYSnf.js";import"./index.esm-BfcSzeJG.js";import"./x-mark-mini-PR8pi-vy.js";import"./Trans-06DGFAnn.js";import"./currency-input-D32zzd4h.js";import"./plus-mini-CX5QGlJp.js";import"./_isIndex-b-rEdJ3S.js";import"./index-CfwWneOF.js";import"./checkbox-Dci4QQUS.js";import"./prompt-Cvy-OtTy.js";import"./index-DYwFha4O.js";var Oe=({form:l,isReturn:g=!1,zone:j,locationId:y,fulfillmentProviderOptions:m,selectedProviderId:_,type:b})=>{const{t}=Q(),d=b==="pickup",u=H({queryFn:s=>J.admin.shippingProfile.list(s),queryKey:["shipping_profiles"],getOptions:s=>s.shipping_profiles.map(o=>({label:o.name,value:o.id}))}),i=H({queryFn:s=>J.admin.fulfillmentProvider.list({...s,stock_location_id:y}),queryKey:["fulfillment_providers"],getOptions:s=>s.fulfillment_providers.map(o=>({label:oe(o.id),value:o.id}))});return e.jsx("div",{className:"flex flex-1 flex-col items-center overflow-y-auto",children:e.jsxs("div",{className:"flex w-full max-w-[720px] flex-col gap-y-8 px-6 py-16",children:[e.jsxs("div",{children:[e.jsx(me,{children:t(`stockLocations.shippingOptions.create.${d?"pickup":g?"returns":"shipping"}.header`,{zone:j.name})}),e.jsx(he,{size:"small",className:"text-ui-fg-subtle",children:t(`stockLocations.shippingOptions.create.${g?"returns":d?"pickup":"shipping"}.hint`)})]}),!d&&e.jsx(r.Field,{control:l.control,name:"price_type",render:({field:s})=>e.jsxs(r.Item,{children:[e.jsx(r.Label,{children:t("stockLocations.shippingOptions.fields.priceType.label")}),e.jsx(r.Control,{children:e.jsxs(B,{className:"grid grid-cols-1 gap-4 md:grid-cols-2",...s,onValueChange:s.onChange,children:[e.jsx(B.ChoiceBox,{className:"flex-1",value:"flat",label:t("stockLocations.shippingOptions.fields.priceType.options.fixed.label"),description:t("stockLocations.shippingOptions.fields.priceType.options.fixed.hint")}),e.jsx(B.ChoiceBox,{className:"flex-1",value:"calculated",label:t("stockLocations.shippingOptions.fields.priceType.options.calculated.label"),description:t("stockLocations.shippingOptions.fields.priceType.options.calculated.hint")})]})}),e.jsx(r.ErrorMessage,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx(r.Field,{control:l.control,name:"name",render:({field:s})=>e.jsxs(r.Item,{children:[e.jsx(r.Label,{children:t("fields.name")}),e.jsx(r.Control,{children:e.jsx(ge,{...s})}),e.jsx(r.ErrorMessage,{})]})}),e.jsx(r.Field,{control:l.control,name:"shipping_profile_id",render:({field:s})=>e.jsxs(r.Item,{children:[e.jsx(r.Label,{children:t("stockLocations.shippingOptions.fields.profile")}),e.jsx(r.Control,{children:e.jsx(G,{...s,options:u.options,searchValue:u.searchValue,onSearchValueChange:u.onSearchValueChange,disabled:u.disabled})}),e.jsx(r.ErrorMessage,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx(r.Field,{control:l.control,name:"provider_id",render:({field:s})=>e.jsxs(r.Item,{children:[e.jsx(r.Label,{tooltip:t("stockLocations.fulfillmentProviders.shippingOptionsTooltip"),children:t("stockLocations.shippingOptions.fields.provider")}),e.jsx(r.Control,{children:e.jsx(G,{...s,onChange:o=>{s.onChange(o),l.setValue("fulfillment_option_id","")},options:i.options,searchValue:i.searchValue,onSearchValueChange:i.onSearchValueChange,disabled:i.disabled})}),e.jsx(r.ErrorMessage,{})]})}),e.jsx(r.Field,{control:l.control,name:"fulfillment_option_id",render:({field:s})=>e.jsxs(r.Item,{children:[e.jsx(r.Label,{children:t("stockLocations.shippingOptions.fields.fulfillmentOption")}),e.jsx(r.Control,{children:O.createElement(N,{...s,onValueChange:s.onChange,disabled:!_,key:_},e.jsx(N.Trigger,{ref:s.ref,children:e.jsx(N.Value,{})}),e.jsx(N.Content,{children:m==null?void 0:m.filter(o=>!!o.is_return===g).map(o=>e.jsx(N.Item,{value:o.id,children:o.name||o.id},o.id))}))}),e.jsx(r.ErrorMessage,{})]})})]}),e.jsx(fe,{}),e.jsx(ye,{control:l.control,name:"enabled_in_store",label:t("stockLocations.shippingOptions.fields.enableInStore.label"),description:t("stockLocations.shippingOptions.fields.enableInStore.hint")})]})})},Pe=({form:l,type:g})=>{const j=g==="pickup",{getIsOpen:y,setIsOpen:m}=Se(),[_,b]=O.useState(null),t=c=>{m(V,!0),b(c)},d=()=>{m(V,!1),b(null)},{store:u,isLoading:i,isError:s,error:o}=xe(),f=O.useMemo(()=>{var c;return((c=u==null?void 0:u.supported_currencies)==null?void 0:c.map(S=>S.currency_code))||[]},[u]),{regions:x,isLoading:T,isError:F,error:L}=_e({fields:"id,name,currency_code",limit:999}),{price_preferences:z}=je({}),{setCloseOnEscape:R}=X(),I=U({control:l.control,name:"name"}),D=se({name:I,currencies:f,regions:x,pricePreferences:z}),n=i||!u||T||!x,C=O.useMemo(()=>[[...f||[],...x||[]]],[f,x]);if(O.useEffect(()=>{!n&&j&&(f.length>0&&f.forEach(c=>{l.setValue(`currency_prices.${c}`,"0")}),x.length>0&&x.forEach(c=>{l.setValue(`region_prices.${c.id}`,"0")}))},[n,j]),s)throw o;if(F)throw L;return e.jsx(ve,{id:V,onOpenChangeCallback:c=>{c||b(null)},children:e.jsx(ie,{onOpenConditionalPricesModal:t,onCloseConditionalPricesModal:d,children:e.jsxs("div",{className:"flex size-full flex-col divide-y overflow-hidden",children:[e.jsx(te,{isLoading:n,data:C,columns:D,state:l,onEditingChange:c=>R(!c),disableInteractions:y(V)}),_&&e.jsx(ne,{info:_,variant:"create"})]})})})},Y=a.object({name:a.string().min(1),price_type:a.nativeEnum(re),enabled_in_store:a.boolean(),shipping_profile_id:a.string().min(1),provider_id:a.string().min(1),fulfillment_option_id:a.string().min(1)}),we=a.object({conditional_region_prices:a.record(a.string(),a.array(q).optional()),conditional_currency_prices:a.record(a.string(),a.array(q).optional())}),Le=a.object({region_prices:a.record(a.string(),a.string().optional()),currency_prices:a.record(a.string(),a.string().optional())}).merge(Y).merge(we);function Ee({zone:l,isReturn:g,locationId:j,type:y}){var I,D;const[m,_]=O.useState("details"),[b,t]=O.useState(!1),{t:d}=Q(),{handleSuccess:u}=X(),i=pe({defaultValues:{name:"",price_type:"flat",enabled_in_store:!0,shipping_profile_id:"",provider_id:"",fulfillment_option_id:"",region_prices:{},currency_prices:{},conditional_region_prices:{},conditional_currency_prices:{}},resolver:de(Le)}),s=U({control:i.control,name:"provider_id"}),{fulfillment_options:o}=ue(s,{enabled:!!s}),f=i.watch("price_type")==="calculated",{mutateAsync:x,isPending:T}=be(),F=i.handleSubmit(async n=>{const C=Object.entries(n.currency_prices).map(([p,h])=>{if(h)return{currency_code:p,amount:M(h)}}).filter(p=>!!p),c=Object.entries(n.region_prices).map(([p,h])=>{if(h)return{region_id:p,amount:M(h)}}).filter(p=>!!p),S=Object.entries(n.conditional_region_prices).flatMap(([p,h])=>{const v=(h==null?void 0:h.map(k=>({region_id:p,amount:M(k.amount),rules:A(k)})))||[];return v==null?void 0:v.filter(Boolean)}),E=Object.entries(n.conditional_currency_prices).flatMap(([p,h])=>{const v=(h==null?void 0:h.map(k=>({currency_code:p,amount:M(k.amount),rules:A(k)})))||[];return v==null?void 0:v.filter(Boolean)}),$=[...C,...E,...c,...S],ee=o==null?void 0:o.find(p=>p.id===n.fulfillment_option_id);await x({name:n.name,price_type:n.price_type,service_zone_id:l.id,shipping_profile_id:n.shipping_profile_id,provider_id:n.provider_id,prices:$,data:ee,rules:[{value:g?"true":"false",attribute:"is_return",operator:"eq"},{value:n.enabled_in_store?"true":"false",attribute:"enabled_in_store",operator:"eq"}],type:{label:"Type label",description:"Type description",code:"type-code"}},{onSuccess:({shipping_option:p})=>{Z.success(d(`stockLocations.shippingOptions.create.${g?"returns":"shipping"}.successToast`,{name:p.name})),u(`/settings/locations/${j}`)},onError:p=>{Z.error(p.message)}})}),L=n=>{if(n==="pricing"){i.clearErrors();const C=Y.safeParse({...i.getValues()});if(!C.success){const[c,...S]=C.error.errors;for(const E of S){const $=E.path.join(".");i.setError($,{message:E.message,type:E.code})}i.setError(c.path.join("."),{message:c.message,type:c.code},{shouldFocus:!0}),t(!1);return}t(!0)}_(n)},z=(I=i.getFieldState("currency_prices"))!=null&&I.isDirty||(D=i.getFieldState("region_prices"))!=null&&D.isDirty||m==="pricing"?"in-progress":"not-started",R=b?"completed":"in-progress";return e.jsx(w.Form,{form:i,children:e.jsx(Ce,{className:"flex h-full flex-col",onSubmit:F,onKeyDown:n=>{const C=n.key==="Enter",c=n.metaKey||n.ctrlKey,S=m!=="pricing"&&!f;if(C&&(n.preventDefault(),!!c)){if(S){n.stopPropagation(),L("pricing");return}F()}},children:e.jsxs(P,{value:m,className:"flex h-full flex-col overflow-hidden",onValueChange:n=>L(n),children:[e.jsx(w.Header,{children:e.jsxs(P.List,{className:"border-ui-border-base -my-2 ml-2 min-w-0 flex-1 border-l",children:[e.jsx(P.Trigger,{value:"details",status:R,className:"w-full max-w-[200px]",children:e.jsx("span",{className:"w-full cursor-auto overflow-hidden text-ellipsis whitespace-nowrap",children:d("stockLocations.shippingOptions.create.tabs.details")})}),!f&&e.jsx(P.Trigger,{value:"pricing",status:z,className:"w-full max-w-[200px]",children:e.jsx("span",{className:"w-full overflow-hidden text-ellipsis whitespace-nowrap",children:d("stockLocations.shippingOptions.create.tabs.prices")})})]})}),e.jsxs(w.Body,{className:"size-full overflow-hidden",children:[e.jsx(P.Content,{value:"details",className:"size-full overflow-y-auto",children:e.jsx(Oe,{form:i,zone:l,isReturn:g,type:y,locationId:j,fulfillmentProviderOptions:o||[],selectedProviderId:s})}),e.jsx(P.Content,{value:"pricing",className:"size-full",children:e.jsx(Pe,{form:i,type:y})})]}),e.jsx(w.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(w.Close,{asChild:!0,children:e.jsx(K,{variant:"secondary",size:"small",children:d("actions.cancel")})}),m==="pricing"||f?e.jsx(K,{size:"small",className:"whitespace-nowrap",isLoading:T,type:"submit",children:d("actions.save")},"submit-btn"):e.jsx(K,{size:"small",className:"whitespace-nowrap",isLoading:T,onClick:()=>L("pricing"),type:"button",children:d("actions.continue")},"continue-btn")]})})]})})})}var ke="*fulfillment_sets,*fulfillment_sets.service_zones,*fulfillment_sets.service_zones.shipping_options";function ns(){var o,f;const{location_id:l,fset_id:g,zone_id:j}=ae(),[y]=ce(),m=y.has("is_return"),{stock_location:_,isPending:b,isFetching:t,isError:d,error:u}=le(l,{fields:ke}),i=(o=_==null?void 0:_.fulfillment_sets)==null?void 0:o.find(x=>x.id===g);if(!b&&!t&&!i)throw W({message:`Fulfillment set with ID ${g} was not found`},404);const s=(f=i==null?void 0:i.service_zones)==null?void 0:f.find(x=>x.id===j);if(!b&&!t&&!s)throw W({message:`Service zone with ID ${j} was not found`},404);if(d)throw u;return e.jsx(w,{prev:`/settings/locations/${l}`,children:s&&e.jsx(Ee,{zone:s,isReturn:m,locationId:l,type:i.type})})}export{ns as Component};
