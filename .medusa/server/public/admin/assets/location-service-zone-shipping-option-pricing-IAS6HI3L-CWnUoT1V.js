import{U as v,u as ie,b as D,S as se,a as ne}from"./chunk-X4NONLSC-CKg3ZlG4.js";import{C as O,R as j,I}from"./chunk-PYIO3TDQ-D8Zv8hXV.js";import{D as oe}from"./chunk-GE4APTT2-CV1WcpOh.js";import{a5 as te,aw as R,a7 as y,aj as A,ah as F,U as ce,az as ae,j as n,b as de,r as L,ac as le,ad as ue,g as pe,i as me,l as fe,t as N,B as U}from"./index-C9AxsCP1.js";import{d as ge,c as he}from"./chunk-BF3VCHXD-cND4E_0H.js";import{c as T}from"./chunk-6GU6IDUA-CDc7wW5L.js";import{K as _e}from"./chunk-6HTZNHPT-BkGNcgHF.js";import{R as S,u as k,a as ye,S as Se}from"./chunk-JGQGO74V-BufRAs73.js";import"./chunk-PDWBYQOW-BedvhUOI.js";import"./chunk-MWVM4TYO-bKUcYSnf.js";import"./index.esm-DPu9n2Ar.js";import"./x-mark-mini-Dajb-hIL.js";import"./Trans-Sh1iwXmE.js";import"./currency-input-BMvmV8zi.js";import"./_isIndex-jBi_gNPs.js";import"./index-BonVgKHu.js";import"./prompt-klaj1z2V.js";var xe=te({region_prices:R(y(),y().or(A()).optional()),currency_prices:R(y(),y().or(A()).optional()),conditional_region_prices:R(y(),F(v)),conditional_currency_prices:R(y(),F(v))});function je({shippingOption:i}){const{t:e}=de(),{handleSuccess:p}=k(),{getIsOpen:a,setIsOpen:u}=ye(),[f,r]=L.useState(null),h=t=>{u(O,!0),r(t)},_=()=>{u(O,!1),r(null)},m=le({defaultValues:Pe(i.prices),resolver:ue(xe)}),{mutateAsync:o,isPending:d}=he(i.id),{store:b,isLoading:z,isError:V,error:q}=pe(),x=L.useMemo(()=>{var t;return((t=b==null?void 0:b.supported_currencies)==null?void 0:t.map(w=>w.currency_code))||[]},[b]),{regions:g,isLoading:K,isError:G,error:$}=me({fields:"id,name,currency_code",limit:999}),{price_preferences:H}=fe({}),{setCloseOnEscape:Z}=k(),J=ie({name:i.name,currencies:x,regions:g,pricePreferences:H}),Q=L.useMemo(()=>[[...x||[],...g||[]]],[x,g]),M=m.handleSubmit(async t=>{const w=Object.entries(t.currency_prices).map(([s,c])=>{if(!c||!x.some(E=>E.toLowerCase()===s.toLowerCase()))return;const l={currency_code:s,amount:T(c)},C=i.prices.find(E=>E.currency_code===s&&!E.price_rules.length);return C&&(l.id=C.id),l}).filter(s=>!!s),X=Object.entries(t.conditional_currency_prices).flatMap(([s,c])=>c==null?void 0:c.map(l=>({id:l.id,currency_code:s,amount:T(l.amount),rules:D(l)}))),Y=Object.entries(t.region_prices).map(([s,c])=>!c||!(g!=null&&g.some(C=>C.id===s))?void 0:{region_id:s,amount:T(c)}).filter(s=>!!s),ee=Object.entries(t.conditional_region_prices).flatMap(([s,c])=>c==null?void 0:c.map(l=>({id:l.id,region_id:s,amount:T(l.amount),rules:D(l)}))),re=[...w,...X,...Y,...ee];await o({prices:re},{onSuccess:()=>{N.success(e("general.success")),p()},onError:s=>{N.error(s.message)}})}),W=z||K||!x||!g;if(V)throw q;if(G)throw $;return n.jsx(S.Form,{form:m,children:n.jsxs(_e,{className:"flex h-full flex-col overflow-hidden",onSubmit:M,children:[n.jsx(S.Header,{}),n.jsx(S.Body,{children:n.jsx(Se,{id:O,onOpenChangeCallback:t=>{t||r(null)},children:n.jsxs(se,{onOpenConditionalPricesModal:h,onCloseConditionalPricesModal:_,children:[n.jsx("div",{className:"flex size-full flex-col divide-y overflow-hidden",children:n.jsx(oe,{isLoading:W,data:Q,columns:J,state:m,onEditingChange:t=>Z(!t),disableInteractions:a(O)})}),f&&n.jsx(ne,{info:f,variant:"update"})]})})}),n.jsx(S.Footer,{children:n.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[n.jsx(S.Close,{asChild:!0,children:n.jsx(U,{variant:"secondary",size:"small",children:e("actions.cancel")})}),n.jsx(U,{size:"small",className:"whitespace-nowrap",isLoading:d,onClick:M,type:"button",children:e("actions.save")})]})})]})})}var P=(i,e)=>{var a;const p=["eq","gt","lt"].includes(e)?void 0:null;return((a=i==null?void 0:i.find(u=>u.attribute===I&&u.operator===e))==null?void 0:a.value)||p},B=i=>{const e=i.price_rules||[];return{id:i.id,amount:i.amount,gte:P(e,"gte"),lte:P(e,"lte"),gt:P(e,"gt"),lt:P(e,"lt"),eq:P(e,"eq")}},Pe=i=>{const e=(r,h,_=[])=>{var o;const m=((o=r.price_rules)==null?void 0:o.map(d=>d.attribute))||[];return h.every(d=>m.includes(d))&&!_.some(d=>m.includes(d))},p={},a={},u={},f={};return i.forEach(r=>{var h,_,m;if(!((h=r.price_rules)!=null&&h.length)){p[r.currency_code]=r.amount;return}if(e(r,[I],[j])){const o=r.currency_code;a[o]||(a[o]=[]),a[o].push(B(r));return}if(e(r,[j],[I])){const o=(_=r.price_rules.find(d=>d.attribute===j))==null?void 0:_.value;u[o]=r.amount;return}if(e(r,[j,I])){const o=(m=r.price_rules.find(d=>d.attribute===j))==null?void 0:m.value;f[o]||(f[o]=[]),f[o].push(B(r))}}),{currency_prices:p,conditional_currency_prices:a,region_prices:u,conditional_region_prices:f}};function Be(){const{so_id:i,location_id:e}=ce();if(!i)throw ae({message:"Shipping Option ID paramater is missing",status:404});const{shipping_option:p,isError:a,error:u}=ge(i,{fields:"*prices,*prices.price_rules"});if(a)throw u;return n.jsx(S,{prev:`/settings/locations/${e}`,children:p&&n.jsx(je,{shippingOption:p})})}export{Be as Component};
